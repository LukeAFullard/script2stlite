<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>User App</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@stlite/browser@0.89.0/build/stlite.css"
    />
  </head>
  <body>
    <div id="root"></div>
    <script type="module">
import { mount } from "https://cdn.jsdelivr.net/npm/@stlite/browser@0.89.0/build/stlite.js"
mount(
  {
    sharedWorker: true,
    streamlitConfig : {},
    requirements: ['streamlit'],
    entrypoint: "app.py",
    pyodideUrl: "https://cdn.jsdelivr.net/pyodide/v0.28.2/full/pyodide.js",
    files: {
"app.py": `
import streamlit as st
import asyncio
import os

st.title("User App (File Reader)")

st.write(
    "This app is part of a diagnostic test. Its purpose is to read a file "
    "that should have been created by the 'Installer App'."
)

if st.button("Read the test file"):
    file_path = "/mnt/test.txt"
    max_retries = 5
    retry_delay = 2  # seconds

    for attempt in range(max_retries):
        st.info(f"Attempt {attempt + 1}: Checking for file \`{file_path}\`...")
        if os.path.exists(file_path):
            try:
                with open(file_path, "r") as f:
                    content = f.read()
                st.success(f"Successfully read the file on attempt {attempt + 1}!")
                st.text_area("File Content", content, height=150)
                # Exit the loop on success
                break
            except Exception as e:
                st.error(f"File exists, but failed to read it: {e}")
                break # Exit loop if reading fails
        else:
            if attempt < max_retries - 1:
                st.write(f"File not found. Retrying in {retry_delay} seconds...")
                await asyncio.sleep(retry_delay)
            else:
                st.error(
                    f"Failed to find file \`{file_path}\` after {max_retries} attempts. "
                    "This suggests the file system is not shared as expected."
                )

`,

},
  },
  document.getElementById("root")
)

function Ou(n){const i=window.atob(n),a=i.length,l=new Uint8Array(a);for(let u=0;u<a;u++)l[u]=i.charCodeAt(u);return l}
    </script>
  </body>
  <!-- We love stlite! https://github.com/whitphx/stlite and Pyodide https://github.com/pyodide/pyodide -->
</html>